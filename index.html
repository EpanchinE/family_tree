<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
	<head>
		<title>BASE FAMILY TREE WEB APPLICATION</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<link href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAAEkYuABNKMQAfk2gAITwrABlJLgAVeVEA2fPoABp8UQAaelQA+P38ABRdPQAno2sA/v7/AP/+/wAVjWAAIoVaACWGXQA2oW4AH41gAB+RYwARSS8AF3NJABhzSQAWd0wAE1E1AGKrggAtZEkAF39SABAwGwAhd0wAFVs4ABxTOwAdg1UAK3NSAC6ebwBBiWYAKadvAFGngAAlhl4AEHNKAEO8iQARSTAAEkkwABdJMAAZRzMAKY5kACqOZAAhbUoAMVpHABJUNgDh7+cAHKd5ADKVZwAbhFkA5vTtADVxVgAjilkAMUs/AEKScAAac0sAGXROABlHNAAgc0sA9/v5APr++QAdTT0AF1s6ABaHWgAqTDoANpVxAB+PYAAVQykAGz8mACOIZgAVcEwAsO/YAChhQwAmYkYAI5dmABRQNQA4iF0ADjMeACFKNQAJjmcADjchABpYOwAqn2wAEGU+AD2JaQAUPCcAH4pbABdqRABYo4AAY5Z9ACmJYQAXRy0AGEswABdNNgAml2cAFlU8ABdXOQAgpnAAIXtTABBlPwDO49kAEGg/AB2DWQAaiVkAGVpCABtcPwAkqXkAGWBCAB5cPwAiWDwAFZZlABJDKwBLq5AA1OvfABduSABil4EAEUouACuDYgAUeEsAOKl5AB9vSwD1/fkAM4dlABCIYAD9/vwAI3pRAP///wAeglcAFy8mAByHXQASa0AAFmNDABqOYABFi2gAMKlxABlqRgAvr3oAHHJMAB5zTwAfSDIAG3pSABl+VQASXTsAF1c7AB2AUgAcg1sAHIlbAC0kDwAVOCcAFz0kACFfQQC+3coAG2pHABhwRwAlEQQAFU0wAA0qGQALMRwAGnxQAPj9+wAcUDkACzwiAP3+/gDM6NAA/v7+AA5rQgAlUDkA5/fzABJBKAAXZkUANZ9wACCMXACJmYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIODg4ODg4OYg4ODg4ODg4ODg6mBfqepn6RpNwqDg4ODqXReU5A4EUsiZ2VxGwVMg3grbj4EOjEclg8hL6piVDN2Mh1tRZmiQoWIE5Iph291hosnAXkCUK2aFUctlz1YgH8IC2tVEGiJZmOdkWByrnpdhHCeaqUuSKE/r09fQ5M7QDCmd0QgFFeVKKtkjY59JKk0ik5hIxlalCo5CTw2EqyDB4xJo1KgUXtcj7AGViaDg4OoFx4fGCxNsZsWNQOpg4ODg4NGggwlbFtzfEGDg4ODg4ODDakaSlmcqQ6Dg4ODAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAA=" rel="icon" type="image/x-icon">
		<link rel="stylesheet" type="text/css" href="assets/css/style.css">
		<!-- OSX Style CSS files -->
		<link type='text/css' href='assets/css/osx.css' rel='stylesheet' media='screen'>
		<link rel="stylesheet" type="text/css" href="assets/css/ui-lightness/jquery-ui-1.8.17.custom.css" />
		<script type="text/javascript" src="/js/libs/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="/js/libs/json2.js"></script>
		<script type="text/javascript" src="/js/libs/underscore-min.js"></script>
		<script type="text/javascript" src="/js/libs/backbone-min.js"></script>
	<!--	<script type="text/javascript" src="/js/app/controllers/BaseController.js"></script>
		<script type="text/javascript" src="/js/app/models/BaseModel.js"></script>
		<script type="text/javascript" src="/js/app/views/BaseView.js"></script>
		<script type="text/javascript" src="/js/app/router.js"></script> -->
		<script src="/js/libs/Three.js" type="text/javascript"></script>
		<script src="/js/libs/js/Stats.js" type="text/javascript"></script>
		<script src="/js/libs/js/helvetiker_regular.typeface.js" type="text/javascript"></script>
		<script src='/js/libs/threex.domevent.js' type="text/javascript"></script>
		<script src='/js/libs/threex.domevent.object3d.js' type="text/javascript"></script>
		<script type="text/javascript" src="js/libs/jquery-ui-1.8.17.custom.min.js"></script>
		<script type="text/javascript" src="/js/libs/tinymce/jscripts/tiny_mce/tiny_mce.js"></script>
	</head>
	<body class="body">
		<div id="navigator">
			<div id="arrowup" class="circle arrow-up">
				<div class="arrow"></div>
			</div>
			<div id="arrowleft" class="circle arrow-left">
				<div class="arrow"></div>
			</div>
			<div id="arrowright" class="circle arrow-right">
				<div class="arrow"></div>
			</div>
			<div id="arrowdown" class="circle arrow-down">
				<div class="arrow"></div>
			</div>
			<div id="plus" class="circle">
				+
			</div>
			<div id="slider"></div>
			<div id="minus" class="circle">
				-
			</div>
		</div>
		<div id="home"></div>
		<script type="text/javascript">
			/////////////////////////////////////////////    VARIABLES   ///////////////////////////////////////////////////////////
			var container, stats;
			var camera, scene, projector, renderer;
			var cube;
            
			var objects = [];
			
            var mouseX = 0;
			var mouseY = 0;
			var isMouseDown = false;
			var onMouseDownPosition;
			
            var mouse = new THREE.Vector2();
			var nodeWidth = 270;
			var nodeHeight = 320;
            var SELECTED;

			/////////////////////////////////////////////    NAVIGATOR   ///////////////////////////////////////////////////////////
			$("#slider").slider({
				orientation : "vertical",
				value : 0,
				min : 100,
				max : 9999,
				slide : function(event, ui) {
					camera.position.z = 10099 - ui.value;
				}
			});
			$('#navigator').on("click", "div", navigation);
            /////////////////////////////////////////////    INIT   ///////////////////////////////////////////////////////////
			init();
			animate();

			function init() {
				container = document.createElement('div');
				document.body.appendChild(container);
				var info = document.createElement('div');
				container.appendChild(info);
				scene = new THREE.Scene();
				camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 10000);
				camera.position.y = 150;
				camera.position.z = 1500;
				scene.add(camera);
				THREE.Object3D._threexDomEvent.camera(camera);

				/////////////////////////////////////////////    CALL TREE   ///////////////////////////////////////////////////////////
				create_tree('{"1":{"l_name":"ffff","b_date":"123","d_date":"456","f_id":"2","m_id":"3","about":"Lorem ipsum dolor sit amet..."},\n\
							"2":{"l_name":"father","b_date":"123","d_date":"456","f_id":"4","m_id":"5","about":"Lorem ipsum dolor sit amet..."},\n\
							"3":{"l_name":"mot","b_date":"123","d_date":"456","f_id":"10","m_id":"","about":"Lorem ipsum dolor sit amet..."},\n\
							"4":{"l_name":"fff1","b_date":"123","d_date":"456","f_id":"6","m_id":"7","about":"Lorem ipsum dolor sit amet..."},\n\
							"5":{"l_name":"fff2","b_date":"123","d_date":"456","f_id":"8","m_id":"9","about":"Lorem ipsum dolor sit amet..."},\n\
							"6":{"l_name":"fff2","b_date":"123","d_date":"456","f_id":"","m_id":"","about":"Lorem ipsum dolor sit amet..."},\n\
							"7":{"l_name":"fff2","b_date":"123","d_date":"456","f_id":"","m_id":"","about":"Lorem ipsum dolor sit amet..."},\n\
							"8":{"l_name":"fff2","b_date":"123","d_date":"456","f_id":"","m_id":"","about":"Lorem ipsum dolor sit amet..."},\n\
							"9":{"l_name":"fff2","b_date":"123","d_date":"456","f_id":"","m_id":"","about":"Lorem ipsum dolor sit amet..."},\n\
							"10":{"l_name":"fff2","b_date":"123","d_date":"456","f_id":"","m_id":"11","about":"Lorem ipsum dolor sit amet..."},\n\
							"11":{"l_name":"fff2","b_date":"123","d_date":"456","f_id":"","m_id":"","about":"Lorem ipsum dolor sit amet..."}}', "1", 1);
								
				projector = new THREE.Projector();
				onMouseDownPosition = new THREE.Vector2();
				renderer = new THREE.CanvasRenderer();
				renderer.setSize(window.innerWidth, window.innerHeight);
				container.appendChild(renderer.domElement);
                
				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				stats.domElement.style.right = '0px';
				container.appendChild(stats.domElement);
                /////////////////////////////////////////////    EVENTS   ///////////////////////////////////////////////////////////
				renderer.domElement.addEventListener('mousedown', onDocumentMouseDown, false);
				renderer.domElement.addEventListener('mouseup', onDocumentMouseUp, false);
				renderer.domElement.addEventListener('mousemove', onDocumentMouseMove, false);
				renderer.domElement.addEventListener('mousewheel', onDocumentMouseWheel, false);
				renderer.domElement.addEventListener('click', onClick, false);
                
                for(var key in objects) {
					objects[key].children[0].on('dblclick', function() {
						OSX.init_view(objects[key].info);
					});
				}
			}
            /////////////////////////////////////////////    NODE CREATION   ///////////////////////////////////////////////////////////
			function create_node(l_name, f_name, b_date, d_date, about, width, height) {
				var cube = new THREE.Object3D();
				// TODO coords
				
				var photo = texture('trash/image.jpg', 128, 128);
				photo.position.set(0, 32, -1);
				container.style.background = "url('trash/leafs_tr.jpg')";
				
				//parent "+"					
				var imgPlusSize = 70;
				var par_voxel = new THREE.Mesh(new THREE.PlaneGeometry(imgPlusSize, imgPlusSize));
				par_voxel.add(texture('trash/man.png', imgPlusSize, imgPlusSize));
				par_voxel.position.set(mouseX, mouseY - Math.floor(height / 2), 1);
				par_voxel.matrixAutoUpdate = false;
				par_voxel.updateMatrix();
				par_voxel.overdraw = true;
				par_voxel.visible = false;
				par_voxel.name = 'parent';

				//child "+"
				var child_voxel = new THREE.Mesh(new THREE.PlaneGeometry(imgPlusSize, imgPlusSize));
				child_voxel.add(texture('trash/man.png', imgPlusSize, imgPlusSize));
				child_voxel.position.set(mouseX, mouseY + Math.floor(height / 2), 1);
				child_voxel.matrixAutoUpdate = false;
				child_voxel.updateMatrix();
				child_voxel.overdraw = true;
				child_voxel.visible = false;
				child_voxel.name = 'child';
				
				// arrow
				var arrow = new THREE.Mesh(new THREE.PlaneGeometry(30, 48));
				arrow.add(texture('trash/arrow.png', 30, 48));
				arrow.position.set(mouseX, mouseY - 30 - Math.floor(height / 2), 1);
				arrow.overdraw = true;
				arrow.name = 'arrow';
				arrow.visible = false;
				arrow.on('click', function() { console.log('arrow click');OSX.init_view(cube.info); }); // Dont work! Why?!!
				
				
				
				cube.add(texture('trash/pergament.png', width * 0.8, height));			// children[0]
				cube.add(photo);												// children[1]
				cube.add(text(l_name, f_name, b_date, d_date, nodeWidth, nodeHeight));	// children[2]
				cube.add(par_voxel);											// children[3]
				cube.add(child_voxel);											// children[4]
				cube.add(arrow);												// children[5]
				cube.info = {
					"l_name" : l_name,
					"f_name" : f_name,
					"b_date" : b_date,
					"d_date" : d_date,
					"about" : about
				};
				cube.mother;
				cube.father;
				cube.child;
				cube.lineM;
				cube.lineF;
				cube.lineC;
				cube.redrawLine = function(){
					if(cube.mother){
						cube.lineM.geometry.vertices[0].position.set(cube.position.x,cube.position.y,-10);
						cube.lineM.geometry.vertices[1].position.set(cube.position.x, cube.position.y - 200, -10);
						cube.lineM.geometry.vertices[2].position.set(cube.mother.position.x, cube.position.y - 200, -10);
					};
					if(cube.father){
						cube.lineF.geometry.vertices[0].position.set(cube.position.x,cube.position.y,-10);
						cube.lineF.geometry.vertices[1].position.set(cube.position.x, cube.position.y - 200, -10);
						cube.lineF.geometry.vertices[2].position.set(cube.father.position.x, cube.position.y - 200, -10);
					};
					if(cube.child){
					cube.lineC.geometry.vertices[2].position.set(cube.position.x, cube.child.position.y - 200, -10);
					cube.lineC.geometry.vertices[3].position.set(cube.position.x,cube.position.y,-10);
					};
				}
				return cube;
			}
            /////////////////////////////////////////////    TEXT   ///////////////////////////////////////////////////////////
			function text(l_name, f_name, b_date, d_date, width, height) {
				var canvas = document.createElement('canvas');
				canvas.width = width;
				canvas.height = height;
				var context = canvas.getContext("2d");
				context.fillStyle = "black";
				context.font = '22px Arial Black';
				//TODO text align
				context.fillText(f_name, width * 0.35, height * 0.68);
				context.fillText(l_name, width * 0.35, height * 0.74);
				context.fillText(b_date, width * 0.25, height * 0.82);
				context.fillText(d_date, width * 0.5, height * 0.82);
				var tex = new THREE.Texture(canvas);
				tex.needsUpdate = true;
				var mat = new THREE.MeshBasicMaterial({
					map : tex,
					overdraw : true
				});
				mat.transparent = true;
				var item = new THREE.Mesh(new THREE.PlaneGeometry(width, height), mat);
                
                item.position.z = 1;

				return item;
			}
            /////////////////////////////////////////////    TEXTURE   ///////////////////////////////////////////////////////////
			function texture(path, size_x, size_y) {
				var tex = THREE.ImageUtils.loadTexture(path);
				var mat = new THREE.MeshBasicMaterial({
					map : tex,
					overdraw : true
				});
				mat.transparent = true;
				var item = new THREE.Mesh(new THREE.PlaneGeometry(size_x, size_y), mat);
				return item;
			};
            /////////////////////////////////////////////    LINES   ///////////////////////////////////////////////////////////
			function create_line_c(color,child,parent) {
				var lineMat = new THREE.LineBasicMaterial({
					color : color,
					opacity : 1,
					linewidth : 3
				});

				var geom = new THREE.Geometry();
				geom.vertices.push(new THREE.Vertex(new THREE.Vector3(child.position.x, child.position.y, -10)));
				geom.vertices.push(new THREE.Vertex(new THREE.Vector3(child.position.x, child.position.y - 200, -10)));
				geom.vertices.push(new THREE.Vertex(new THREE.Vector3(parent.position.x, child.position.y - 200, -10)));
				geom.vertices.push(new THREE.Vertex(new THREE.Vector3(parent.position.x, parent.position.y, -10)));
				line = new THREE.Line(geom, lineMat);
				return line;
			};
			/////////////////////////////////////////////    TREE CREATION   ///////////////////////////////////////////////////////////
			function create_tree(json, id, i, nodex) {
				var data = JSON.parse(json);
				if(i == 1) {//TODO f_name
					var node = create_node(data[id].l_name, data[id].l_name, data[id].b_date, data[id].d_date, data[id].about, nodeWidth, nodeHeight);
					node.position.set(0, nodeHeight + 50, 0);
					node.info.user_id = id;
					objects.push(node);
					scene.add(node);
					nodex = node;
				}
				if(i < 4) {
					var a = i + 1;
					if(data[id].f_id) {
						var f_id = data[id].f_id;
						var f_node = create_node(data[f_id].l_name, data[f_id].l_name, data[f_id].b_date, data[f_id].d_date, data[f_id].about, nodeWidth, nodeHeight);
						f_node.position.set(nodex.position.x + (Math.pow((4 - i), 1.25)) * (-nodeWidth), (i - 1) * (-nodeHeight - 50), 0);
						f_node.info.user_id = f_id;
						objects.push(f_node);
						scene.add(f_node);
						lineFc = create_line_c(0x000000,nodex,f_node);
						scene.add(lineFc);
						nodex.father = f_node;
						nodex.lineF = lineFc;
						f_node.lineC = lineFc;
						f_node.child = nodex;
						if(i==3){
							f_node.children[5].visible = true;
						}
						create_tree(json, f_id, a, f_node);
					};
					if(data[id].m_id) {
						var m_id = data[id].m_id;
						var m_node = create_node(data[m_id].l_name, data[m_id].l_name, data[m_id].b_date, data[m_id].d_date, data[m_id].about, nodeWidth, nodeHeight);
						m_node.position.set(nodex.position.x + (Math.pow((4 - i), 1.25)) * nodeWidth, (i - 1) * (-nodeHeight - 50), 0);
						m_node.info.user_id = m_id;
						objects.push(m_node);
						scene.add(m_node);
						lineMc = create_line_c(0x000000,nodex,m_node);
						scene.add(lineMc);
						nodex.mother = m_node;
						nodex.lineM = lineMc;
						m_node.lineC = lineMc;
						m_node.child = nodex;
						if(i==3){
							m_node.children[5].visible = true;
						}
						create_tree(json, m_id, a, m_node);
					};
					
				}
			}
            /////////////////////////////////////////////    MOUSE DOWN   ///////////////////////////////////////////////////////////
			function onDocumentMouseDown(event) {

				event.preventDefault();
				var vector = new THREE.Vector3(mouse.x, mouse.y, 0.5);
				projector.unprojectVector(vector, camera);
				var ray = new THREE.Ray(camera.position, vector.subSelf(camera.position).normalize());
				var intersects = ray.intersectObjects(objects);
				if(intersects.length > 0) {
					SELECTED = intersects[0].object.parent;
				} else {
					isMouseDown = true;
					container.style.cursor = 'move';
					SELECTED = null;
				}
				onMouseDownPosition.x = event.clientX;
				onMouseDownPosition.y = event.clientY;
                    
			}
            /////////////////////////////////////////////    MOUSE CLICK   ///////////////////////////////////////////////////////////
			function onClick(event) {
				event.preventDefault();
				var vector = new THREE.Vector3(mouse.x, mouse.y, 0.5);
				projector.unprojectVector(vector, camera);
				var ray = new THREE.Ray(camera.position, vector.subSelf(camera.position).normalize());
				var intersects = ray.intersectObjects(objects);
				if(intersects.length > 0) {
					for(i = 0; i < intersects.length; i++)
					{
						if(intersects[i].object.name == 'child') {
							OSX.init_edit({"action": 'add_child'});
						}
						else if(intersects[i].object.name == 'parent')
						{
							/////////////////////////////////////   ADDING PARENT    /////////////////////////////////////////
                            if (!intersects[0].object.parent.father || !intersects[0].object.parent.mother){
                                nodex = intersects[0].object.parent;
                                i = nodex.generation+1;
                                var p_id = objects.length+1;
    							if (!nodex.father && i<4){
                                    var p_node = create_node('', '', '', '', '', nodeWidth, nodeHeight);
                                    p_node.info.user_id = p_id;                            
                                    p_node.position.set(nodex.position.x + (Math.pow((4 - i), 1.25)) * (-nodeWidth), (i - 1) * (-nodeHeight - 50), 0);
        							objects.push(p_node);
        							scene.add(p_node);
        							lineFc = create_line_c(0x000000,nodex,p_node);
        							scene.add(lineFc);
        							nodex.father = p_node;
        							nodex.lineF = lineFc;
        							p_node.lineC = lineFc;
                                    p_node.generation = i;
                                    p_node.child = nodex;
                                    if(i==3){
                                        p_node.children[5].visible = true;
                                    }
                                } else if (!nodex.mother && i<4){
                                    var p_node = create_node('', '', '', '', '', nodeWidth, nodeHeight);
                                    p_node.info.user_id = p_id;
                                    p_node.position.set(nodex.position.x - (Math.pow((4 - i), 1.25)) * (-nodeWidth), (i - 1) * (-nodeHeight - 50), 0);
        							objects.push(p_node);
        							scene.add(p_node);
        							lineMc = create_line_c(0x000000,nodex,p_node);
        							scene.add(lineMc);
        							nodex.mother = p_node;
        							nodex.lineM = lineMc;
        							p_node.lineC = lineMc;
                                    p_node.generation = i;
                                    p_node.child = nodex;
                                    if(i==3){
                                        p_node.children[5].visible = true;
                                    }
                                }
                            }                            
                            //////////////////////////////////////////////////////////////////////////////////////////////////
                            OSX.init_edit({"action": 'add_parent'});
						}
					}
					/*par = intersects[1].object.parent;
					for( j = 0; j < par.children.length; j++) {
						if(par.children[j].name == 'child' || par.children[j].name == 'parent') {
							par.children[j].visible = true;
						}
					}*/
				} else {
					
				}
			}

            /////////////////////////////////////////////    MOUSE MOVE   ///////////////////////////////////////////////////////////
			function onDocumentMouseMove(event) {
				event.preventDefault();
				mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
				mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
				var vector = new THREE.Vector3(mouse.x, mouse.y, 0.5);
				projector.unprojectVector(vector, camera);
				var ray = new THREE.Ray(camera.position, vector.subSelf(camera.position).normalize());
				var intersects = ray.intersectObjects(objects);

				if( intersects.length > 0 ) {
					container.style.cursor = 'pointer';
					if(intersects.length >1)
					{
						par = intersects[1].object.parent;
						for( j = 0; j < par.children.length; j++) {
							if(par.children[j].name == 'child' || par.children[j].name == 'parent') {
								par.children[j].visible = true;
							}
						}
					}
                    if(SELECTED == intersects[0].object.parent) {
						container.style.cursor = 'pointer';
						var deltaX = -(event.clientX - onMouseDownPosition.x) * camera.position.z / 450;
						var deltaY = (event.clientY - onMouseDownPosition.y) * camera.position.z / 450;
						mouseX -= deltaX;
						mouseY += deltaY;
						onMouseDownPosition.x = event.clientX;
						onMouseDownPosition.y = event.clientY;
						intersects[0].object.parent.position.x -= deltaX;
						intersects[0].object.parent.position.y -= deltaY;
						intersects[0].object.parent.redrawLine();
					}

				} else {

                    if(!SELECTED){
                        for( i = 0; i < objects.length; i++) {
    						for( j = 0; j < objects[i].children.length; j++) {
    							if(objects[i].children[j].name == 'child' || objects[i].children[j].name == 'parent') {
    								objects[i].children[j].visible = false;
    							}
    						}
    					}
    					container.style.cursor = 'auto';
    					if(isMouseDown) {
    						container.style.cursor = 'move';
    						var deltaX = -(event.clientX - onMouseDownPosition.x);
    						var deltaY = event.clientY - onMouseDownPosition.y;
    						camera.position.x += deltaX * camera.position.z / 450;
    						camera.position.y += deltaY * camera.position.z / 450;
    						onMouseDownPosition.x = event.clientX;
    						onMouseDownPosition.y = event.clientY;
    						camera.updateMatrix();
    					} else {
    						container.style.cursor = 'auto';
    					}
                    } else {
   						var deltaX = -(event.clientX - onMouseDownPosition.x) * camera.position.z / 450;
						var deltaY = (event.clientY - onMouseDownPosition.y) * camera.position.z / 450;
						mouseX -= deltaX;
						mouseY += deltaY;
						onMouseDownPosition.x = event.clientX;
						onMouseDownPosition.y = event.clientY;
						SELECTED.position.x -= deltaX;
						SELECTED.position.y -= deltaY;
						SELECTED.redrawLine();
                    }
                    
				}
			}
            /////////////////////////////////////////////    MOUSE UP   ///////////////////////////////////////////////////////////
			function onDocumentMouseUp(event) {
				event.preventDefault();
                SELECTED = null;
				mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
				mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
				var vector = new THREE.Vector3(mouse.x, mouse.y, 0.5);
				projector.unprojectVector(vector, camera);
				var ray = new THREE.Ray(camera.position, vector.subSelf(camera.position).normalize());
				var intersects = ray.intersectObjects(objects);
				if(intersects.length > 0) {
					container.style.cursor = 'pointer';
				} else {
					container.style.cursor = 'auto';
					isMouseDown = false;
					onMouseDownPosition.x = event.clientX - onMouseDownPosition.x;
					onMouseDownPosition.y = event.clientY - onMouseDownPosition.y;
				}
			}
            /////////////////////////////////////////////    MOUSE WHEEL   ///////////////////////////////////////////////////////////
			function onDocumentMouseWheel(event) {
				if(camera.position.z > 0)
					camera.position.z -= event.wheelDeltaY;
				if(camera.position.z < 100)
					camera.position.z = 101;
				if(camera.position.z > 10000)
					camera.position.z = 9999;
				camera.updateMatrix();
			}
            /////////////////////////////////////////////    NAVIGATION   ///////////////////////////////////////////////////////////
			function navigation(event) {
				event.preventDefault();
				switch (this.id) {
					case "arrowdown":
						camera.position.y -= 10;
						break;
					case "arrowup":
						camera.position.y += 10;
						break;
					case "arrowright":
						camera.position.x += 10;
						break;
					case "arrowleft":
						camera.position.x -= 10;
						break;
					case "plus":
						if(camera.position.z > 100)
							camera.position.z -= 10;
						break;
					case "minus":
						if(camera.position.z < 9999)
							camera.position.z += 10;
						break;
				};
			};
            /////////////////////////////////////////////    ANIMATE   ///////////////////////////////////////////////////////////
			function animate() {
				requestAnimationFrame(animate);
				render();
				stats.update();
			}
            /////////////////////////////////////////////    RENDER   ///////////////////////////////////////////////////////////
			function render() {
				$("#slider").slider("value", 10099 - camera.position.z);
				renderer.render(scene, camera);
			}
		</script>
		<div id="osx-modal-content">
			<div id="osx-modal-title">
				OSX Style Modal Dialog
			</div>
			<div class="close">
				<a href="#" class="simplemodal-close">x</a>
			</div>
			<div id="osx-modal-data">
				<!--h2>Hello! I'm SimpleModal!</h2-->
				<div id="div-about"></div>
				<p>
					<input type="button" id="edit_person" value="Edit" onclick="/* OSX.init_edit({'action': 'edit_person'});*/"> <!-- it doesn't work yet! -->
					
					<button class="simplemodal-close">
						Close
					</button>
					<span>(or press ESC or click the overlay)</span>
				</p>
			</div>
		</div>
		
		<div id="osx-modal-content-edit">
			<div id="osx-modal-title-edit">
				OSX Style Modal Dialog
			</div>
			<div class="close">
				<a href="#" class="simplemodal-close">x</a>
			</div>
			<div id="osx-modal-data-edit">
				<!--h2>Hello! I'm SimpleModal!</h2-->
				<table>
					<tr>
						<td class="data-edit-field">
							First name
						</td>
						<td class="data-edit-data">
							<input id="f_name" name="f_name"/>
						</td>
					</tr>
					<tr>
						<td class="data-edit-field">
							Last name
						</td>
						<td class="data-edit-data">
							<input id="l_name" name="l_name"/>
						</td>
					</tr>				
					<tr>
						<td class="data-edit-field">
							Birth date
						</td>
						<td class="data-edit-data">
							<input id="date_b" name="date_b"/>
						</td>
					</tr>
					<tr>
						<td class="data-edit-field">
							Death date
						</td>
						<td class="data-edit-data">
							<input id="date_d" name="date_d"/>
						</td>
					</tr>
					<tr>
						<td class="data-edit-field">
							Sex</td>
						<td>
							<input type="radio" name="sex" value="m" checked /> Male 
							<input type="radio" name="sex" value="f" /> Female
						</td>
						
					</tr>
					<tr>
						<td class="data-edit-field">
							About
						</td>
						<td class="data-edit-data">
							<textarea id="about" name="about" class="mceEditor"></textarea>
						</td>						
					</tr>
				</table>
				<p>
					<input type="submit" id="submit-person" value="Save" />
					<button class="simplemodal-close">
						Close
					</button>
					<span>(or press ESC or click the overlay)</span>
				</p>
			</div>
		</div>
		<script type='text/javascript' src='/js/libs/jquery.simplemodal.js'></script>
		<script type='text/javascript' src='/js/libs/osx.js'></script>
		<a href="#" id="uLogin" style="position:absolute; bottom:0px"><img src="http://ulogin.ru/img/button.png" width="187" height="30" alt="МультиВход"></a>
		<script src="http://ulogin.ru/js/widget.js?display=window&fields=first_name,last_name,photo&redirect_uri=http%3A%2F%2Fstudia-vektor.org.ua%2Fserver%2Fapi%2Flogin" type="text/javascript"></script>
	</body>
</html>